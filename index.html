<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calevid Paystack Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; }
    input, button { width: 100%; padding: 12px; margin-top: 10px; font-size: 16px; }
    button { cursor: pointer; border: none; }
    #generateBtn { background: #ccc; color: #666; }
    #generateBtn.enabled { background: #0b5ed7; color: #fff; }
    #result { margin-top: 20px; }
  </style>
</head>
<body>

<h2>Calevid AI Video Generator</h2>

<input type="text" id="promptInput" placeholder="Enter video prompt..." />
<button id="payBtn">Pay to Generate Video (KES 10)</button>
<button id="generateBtn" disabled>Generate Video</button>

<div id="result"></div>

<script>
const payBtn = document.getElementById("payBtn");
const generateBtn = document.getElementById("generateBtn");
const resultDiv = document.getElementById("result");

let paymentVerified = false;
const BACKEND_URL = "https://calevid-saas-8.onrender.com"; // your backend

// Paystack payment
payBtn.onclick = function() {
  const email = prompt("Enter your email for payment:");
  if (!email) { alert("Email is required"); return; }

  const handler = PaystackPop.setup({
    key: "pk_test_933395bd795d5fe25a99b8674a830422a68c959f", // replace with your Paystack TEST key
    email: email,
    amount: 1000, // KES 10
    currency: "KES",
    ref: "CALEVID_" + Math.floor(Math.random() * 1000000000),

    callback: async function(response) {
      try {
        const verify = await fetch(`${BACKEND_URL}/verify-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ reference: response.reference })
        });

        const data = await verify.json();
        console.log("Payment verification:", data);

        if (data.status === "success") {
          alert("Payment verified! You can now generate a video.");
          paymentVerified = true;
          generateBtn.disabled = false;
          generateBtn.classList.add("enabled");
        } else {
          alert("Payment verification failed. Try again.");
        }

      } catch(err) {
        console.error("Verification error:", err);
        alert("Error verifying payment.");
      }
    },

    onClose: function() { alert("Payment cancelled"); }
  });

  handler.openIframe();
};

// Generate video (test mode)
generateBtn.onclick = async function() {
  if (!paymentVerified) { alert("Please complete payment first."); return; }

  const prompt = document.getElementById("promptInput").value;
  if (!prompt) { alert("Please enter a prompt."); return; }

  resultDiv.innerHTML = "Generating video...";

  try {
    const response = await fetch(`${BACKEND_URL}/generate-video`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, paymentVerified })
    });

    const data = await response.json();

    if (data.videoUrl) {
      resultDiv.innerHTML = `
        <p><strong>Prompt:</strong> ${prompt}</p>
        <p>${data.message}</p>
        <video controls>
          <source src="${data.videoUrl}" type="video/mp4">
        </video>
      `;
    } else {
      resultDiv.innerHTML = "Video generation failed.";
    }

  } catch(err) {
    console.error(err);
    resultDiv.innerHTML = "Error connecting to backend.";
  }
};
</script>

</body>
</html>
